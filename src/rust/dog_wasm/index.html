<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Dog Wasm VAE Explorer</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin-top: 50px; background: #1a1a1a; color: white; }
        canvas { width: 256px; height: 256px; border: 1px solid #444; margin-bottom: 20px;}
        .sliders { display: flex; gap: 20px; }
        .slider-group { display: flex; flex-direction: column; align-items: center; }
        input[type=range] { width: 200px; }
        .grid-canvas { width: 512px; height: 512px; }
    </style>
</head>
<body>

    <h2>üêï Dog VAE Latent Explorer (Wasm + WebGPU)</h2>
    
    <div style='display: flex; gap: 40px; align-items: flex-start;'>
        <div class='explorer'>
            <h3>Interactive Explorer</h3>
            <canvas id='vae-canvas' width='128' height='128'></canvas>
            <div class='sliders'>
                <div class='slider-group'>
                    <label>Principal Component 1</label>
                    <input type='range' id='z1' min='-20' max='20' step='0.1' value='0'>
                </div>
                <div class='slider-group'>
                    <label>Principal Component 2</label>
                    <input type='range' id='z2' min='-20' max='20' step='0.1' value='0'>
                </div>
            </div>
            <p id='status'>Loading Wasm...</p>
        </div>

        <div class='grid-container'>
            <h3>4x4 Latent Grid</h3>
            <canvas id='grid-canvas' width='512' height='512' class='grid-canvas'></canvas>
            <button id='render-grid-btn' style='margin-top: 10px;'>Render Grid</button>
        </div>
    </div>

    <script type='module'>
        import init, { GpuDecoder } from './pkg/dog_wasm.js';

        const PC1 = [0.046425670024299696, -0.012922951326028862, 0.06053657655231705, 0.14235084932068878, -0.021885277969391707, -0.021883743472818875, 0.1476020214572655, 0.07172872221346802, -0.04387968974538949, 0.05071068218851827, -0.04331359748762207, -0.04352969555764239, 0.022615140941636636, -0.17882582319027585, -0.1612204235087889, -0.05255452282377353, -0.09466483509263807, 0.029371305167450353, -0.08486898520750268, -0.13200176643810393, 0.1369876934348887, -0.0211023099747633, 0.006311561950005528, -0.13316489727517317, -0.05088104009624191, 0.01036744275735298, -0.10757826750365956, 0.0351148283630747, -0.05613903580751707, -0.027263321759521245, -0.05623884977195228, 0.17312423104093877, -0.0012615257651274632, -0.098859551859179, 0.07687962671884183, -0.11410684415012952, 0.01952155436481083, -0.18316167956193424, -0.12413966234548282, 0.01839974706102059, 0.06902119772307906, 0.016017033593518446, -0.010809132303729766, -0.02814282768022796, -0.13819089637841817, -0.0672806471996787, -0.043053863980586936, 0.09880452842398199, 0.032116478318786494, -0.16478354803514003, 0.030290692004799284, -0.03599193373982334, -0.06326889867718881, 0.057170671250779084, 0.09636295510493569, 0.08704262451185164, -0.07843794177304872, -0.028900710079774173, 0.030961724493304935, 0.09117987859019583, -0.044786291905492895, -0.01735272155099759, -0.10340422580708011, -0.11180413055231561, 0.0759431868168305, 0.12676174346647204, -0.0067304668542888905, 0.09379577145854101, 0.03380051618416673, -0.06029648374600955, 0.033778045235578764, 0.14375345998736064, -0.0033485010642703653, 0.14624030668357527, -0.24485596195100715, 0.07681958371620386, 0.008135903601918602, -0.027946891594318183, 0.008576473021324188, -0.18576925585957657, -0.020531757584384105, 0.03337772903394308, 0.1381322050843509, -0.0484404198896463, -0.0755663131342817, -0.04689700665182592, 0.08555857810441853, 0.0307269089166415, -0.0495143379003701, 0.04797283173729322, 0.009073408207673668, 0.0905349534104253, -0.06561779059102348, -0.030625128366450427, -0.0366486109179568, -0.13678825466460048, 0.027677049641453084, 0.024399679072670218, 0.00047793212520176414, -0.0219258194677909, -0.13228842913802535, -0.03931585366267584, -0.03203200665886684, -0.07498529998205396, -0.015074660514598132, 0.037764842490975135, 0.17629343501332884, 0.01631701428872236, 0.02407209333947471, -0.0069581297393366826, -0.17933903987548216, -0.0024781344062948163, 0.005629450731904462, 0.23022832107949767, -0.01797912667143667, 0.028184293374801918, -0.0032443552423976653, -0.10923115560579476, 0.10681458251445472, 0.07027984736142137, 0.07393424956681137, -0.08499641422454811, 0.1311129658711606, -0.13102480464843227, 0.05485093111001957, 0.20473217739061536, -0.09258103941435275, -0.052929338474987736];
        const PC2 = [0.007421099468745753, -0.04405892747396552, -0.13866982990038806, 0.0018356726382069062, -0.09312111308750502, 0.042452099679820346, -0.08552930625033832, 0.1346878403692182, -0.06783792132314602, -0.02993033584625432, 0.07309193805655753, -0.10735882727952252, 0.01940799453874667, 0.12067798062183761, -0.13711696065917506, 0.01785423657813128, 0.025743734179539273, 0.06814139018735803, -0.1066716210211844, -0.11264661926134951, 0.042014168192883394, 0.026839821083109908, 0.021924010257885363, 0.03452520127927917, -0.05851857833005113, 0.020193910341201986, 0.02905587083489739, -0.06409574811291006, 0.16635437135442788, 0.04263266839487725, -0.10349036192990979, 0.05282599946542777, -0.08599759835157014, 0.0724039824547059, 0.09999186975018544, -0.06906167760977672, 0.08445880659846863, 0.04186125969047225, 0.07624005357961326, 0.16688456073176486, -0.023704738727454044, -0.0670065640468703, -0.07819710654806691, -0.07117783958333328, -0.00271260103650358, 0.032106241864108355, 0.025698679860961145, 0.07008876121053215, 0.00019639888957660622, 0.13318398876586074, -0.024258404579066806, 0.24117487571224858, 0.05710153310697754, -0.07735450269789425, -0.09738170280710504, 0.04000958428879184, -0.017401720735199508, 0.06388071274146347, 0.040855522071417294, -0.009129301070230692, -0.07341976937387956, -0.13320129432191646, -0.03635100265087905, 0.07890574535634806, 0.016648610782479974, -0.11371574889212764, 0.015486000519641769, 0.031233702760257148, -0.07901908250703185, 0.015355240306224857, 0.004137581940949888, -0.1051476817720361, 0.03168100279952351, 0.04516877065731456, 0.10285324884903761, 0.09074354366081143, -0.12184759279673447, -0.08195386215003848, 0.04520803303412481, 0.05085418902806973, 0.04607130193784497, 0.3390912367870213, 0.0463009822715752, 0.10167094476770758, 0.08644779291296666, 0.0588872490775392, -0.030362962309494156, 0.06608395039763185, -0.06675054115601767, -0.022324866673008405, -0.04311169758056729, 0.004545410068909114, 0.20625803732597114, -0.16391603807903196, 0.06166157078145596, -0.1383025143215778, -0.042477117057084124, 0.09539875293525969, 0.0056598288283708975, -0.09448289204362652, -0.059221397633752476, 0.06115248088086409, -0.06352054896276413, 0.021327788997394768, 0.004469122222566232, -0.05863521538099189, 0.18402380165726442, 0.05547260796267954, -0.179471952443394, 0.016664383286888407, -0.05310382283638245, 0.07531752826804237, -0.07012239544215337, -0.016947022806023608, 0.045107663934629866, 0.07558523894878097, -0.10585383740363703, -0.02629098235896188, -0.04508713136121979, -0.059750903516435805, 0.1536464081847037, 0.038265213472199765, -0.11518149188758339, 0.08490039376950335, 0.1856976608150359, 0.08507143578854243, -0.13137228695453868, -0.04117550562807902];

        async function run() {
            try {
                await init();
                const decoder = await GpuDecoder.new();
                document.getElementById('status').innerText = 'Wasm + WebGPU Ready!';
                
                const canvas = document.getElementById('vae-canvas');
                const ctx = canvas.getContext('2d');
                const z1Input = document.getElementById('z1');
                const z2Input = document.getElementById('z2');

                async function updateImage() {
                    const z1 = parseFloat(z1Input.value);
                    const z2 = parseFloat(z2Input.value);
                    
                    const latent = new Float32Array(128);
                    for (let k = 0; k < 128; k++) {
                        latent[k] = z1 * PC1[k] + z2 * PC2[k];
                    }

                    const pixels = await decoder.generate(latent);
                    const imageData = ctx.createImageData(128, 128);
                    for (let i = 0; i < 128 * 128; i++) {
                        imageData.data[i * 4] = pixels[i * 3];
                        imageData.data[i * 4 + 1] = pixels[i * 3 + 1];
                        imageData.data[i * 4 + 2] = pixels[i * 3 + 2];
                        imageData.data[i * 4 + 3] = 255;
                    }
                    ctx.putImageData(imageData, 0, 0);
                }

                const gridCanvas = document.getElementById('grid-canvas');
                const gridCtx = gridCanvas.getContext('2d');

                async function renderGrid() {
                    const steps = 4;
                    const minZ = -10.0;
                    const maxZ = 10.0;
                    
                    document.getElementById('status').innerText = 'Rendering grid (sequential calls)...';
                    
                    const start = performance.now();
                    const fullImageData = gridCtx.createImageData(512, 512);
                    const imgSize = 128;
                    
                    for (let row = 0; row < steps; row++) {
                        for (let col = 0; col < steps; col++) {
                            const z2 = maxZ - (row / (steps - 1)) * (maxZ - minZ);
                            const z1 = minZ + (col / (steps - 1)) * (maxZ - minZ);
                            
                            const latent = new Float32Array(128);
                            for (let k = 0; k < 128; k++) {
                                latent[k] = z1 * PC1[k] + z2 * PC2[k];
                            }
                            
                            const pixels = await decoder.generate(latent);
                            
                            for (let y = 0; y < imgSize; y++) {
                                for (let x = 0; x < imgSize; x++) {
                                    const pIdx = (y * imgSize + x) * 3;
                                    const canvasX = col * imgSize + x;
                                    const canvasY = row * imgSize + y;
                                    const canvasIdx = (canvasY * 512 + canvasX) * 4;
                                    
                                    fullImageData.data[canvasIdx] = pixels[pIdx];
                                    fullImageData.data[canvasIdx+1] = pixels[pIdx+1];
                                    fullImageData.data[canvasIdx+2] = pixels[pIdx+2];
                                    fullImageData.data[canvasIdx+3] = 255;
                                }
                            }
                        }
                    }
                    gridCtx.putImageData(fullImageData, 0, 0);
                    const end = performance.now();
                    document.getElementById('status').innerText = 'Grid Rendered in ' + Math.round(end-start) + 'ms';
                }

                z1Input.addEventListener('input', updateImage);
                z2Input.addEventListener('input', updateImage);
                document.getElementById('render-grid-btn').addEventListener('click', renderGrid);

                await updateImage();
            } catch (e) {
                document.getElementById('status').innerText = 'Error: ' + e;
                console.error(e);
            }
        }

        run();
    </script>
</body>
</html>